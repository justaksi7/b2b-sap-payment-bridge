asyncapi: 3.0.0
info:
  title: SAP Payment Bridge
  version: 1.0.0
  description: |
    SAP Payment Bridge Events Documentation
defaultContentType: sqs-message
servers:
  Event Dispatcher SQS:
    host: sqs.eu-central-1.amazonaws.com
    protocol: aws-sqs
    pathname: /123456789012/EventDispatcherSQS
    description: >-
      AWS SQS Queue for storing succesful validations by sap that invokes the
      Event Dispatcher lambda after a specific batchSize or a batchWindow is
      reached. The VAlidator Lambda and the Worker Lambda publish messages to
      this Queue.
  POST-SQS:
    host: sqs.eu-central-1.amazonaws.com
    protocol: aws-sqs
    pathname: /123456789012/POST-SQS
    description: AWS SQS Queue        for storing Payment POST Requests
  Worker-SQS:
    host: sqs.eu-central-1.amazonaws.com
    protocol: aws-sqs
    pathname: /123456789012/WORKER-SQS
    description: AWS SQS Queue for storing PaymentCreated Events
  Webhook-SQS:
    host: sqs.eu-central-1.amazonaws.com
    protocol: aws-sqs
    pathname: /123456789012/WEBHOOK-SQS
    description: >-
      AWS SQS Queue for storing PaymentCreated, PaymentSettled and PaymentFailed
      Events
  Logger-SQS:
    host: sqs.eu-central-1.amazonaws.com
    protocol: aws-sqs
    pathname: /123456789012/Logger-SQS
    description: AWS SQS Queue for storing Logs
  Request Dispatcher:
    host: lambda.eu-central-1.amazonaws.com/2015-03-31/functions/RequestDispatcher
    protocol: aws-lambda
    description: >-
      AWS Lambda that receives HTTP Requests from the Gateway. If the Request is
      of type GET it returns the requested Payment information. If it is of type
      POST it writes into the POST-SQS and returns 202 Accepted with 'QUEUED'
  Worker Lambda:
    host: lambda.eu-central-1.amazonaws.com
    protocol: aws-lambda
    pathname: /2015-03-31/functions/WorkerLambda/invocations
    description: >-
      AWS Lambda Worker Function that gets triggerd by the Worker-SQS and
      receives PaymentCreated events to transfer them to SAP. It changes the
      status of the Payment in the Payments Core database and creates either a
      PaymentSettled outbox event or PaymentFailed outbox event depending on the
      SAP response.
  Event Dispatcher:
    host: lambda.eu-central-1.amazonaws.com
    protocol: aws-lambda
    pathname: /2015-03-31/functions/EventDispatcher/invocations
    description: >-
      AWS Lambda Event Dispatcher function that queries the Payments Core
      database outbox event table and Partner Config database. It is
       invoked by the Event Dispatcher SQS and it dispatches the
      outbox events to the Worker-SQS and Webhook-SQS
  Webhook Lambda:
    host: lambda.eu-central-1.amazonaws.com
    protocol: aws-lambda
    pathname: /2015-03-31/functions/WebhookLambda/invocations
    description: >-
      AWS Lambda Webhook function that is triggered by the Webhook-SQS it signs
      the messages from the queue and sends them to the partner specific webhook
      URLs.
  Logger Lambda:
    host: lambda.eu-central-1.amazonaws.com
    protocol: aws-lambda
    pathname: /2015-03-31/functions/LoggerLambda/invocations
    description: AWS Lambda Logger that transfers the logs to Cloud Watch, Data Dog etc.
  Validation Lambda:
    host: lambda.eu-central-1.amazonaws.com
    protocol: aws-lambda
    pathname: /2015-03-31/functions/ValidationLambda/invocations
    description: >-
      AWS Lambda Validator function that tries to ged a validation for partner
      payment requests from SAP. It is triggered by the POST-SQS. Depending ot
      the SAP response it either creates a payment and a PaymentCreated outbox
      event or only a PaymentFailed outbox event in to the Payments Core
      database and it also stores the partner configuration in the Partner
      Config database.
  Health Check Lambda:
    host: lambda.eu-central-1.amazonaws.com
    protocol: aws-lambda
    pathname: /2015-03-31/functions/HealthCheck/invocations
    description: >-
      AWS Lambda Health Check Function that is periodically by an EventBridge
      Scheduler. It checks the health status of SAP and sends the metric to
      CloudWatch
  Circuit Controller Lambda:
    host: lambda.eu-central-1.amazonaws.com
    protocol: aws-lambda
    pathname: /2015-03-31/functions/CircuitController/invocations
    description: >-
      AWS Lambda Circuit Controller Function that reacts to alarms raised by
      CloudWatch and implements a Circuit Breaker Pattern by reducing,
      increasing or setting the SQS Consumer Concurrency to 0.
  Payments Core:
    host: rds.eu-central-1.amazonaws.com
    protocol: aws-rds
    pathname: /123456789012/payments-core-db
    description: AWS RDS Payments Core Database with 2 tables - payments and outbox events.
  Partner Config:
    host: rds.eu-central-1.amazonaws.com
    protocol: aws-rds
    pathname: /123456789012/partner-config-db
    description: >-
      AWS RDS Partner Configuration Database it stores partner configurations
      such as mapping rules, webhook URLs, webhook secrets etc.
  eventbridge-scheduler:
    host: aws.events.eu-central-1
    protocol: aws-eventbridge
    pathname: 123456789012:schedule/dispatcher-poll
    description: >-
      AWS EventBridge Scheduler, konfiguriert mit rate(30 seconds), triggert
      Dispatcher Lambda.
  DLQ-Example:
    host: rds.eu-central-1.amazonaws.com
    protocol: aws-sqs
    pathname: /123456789012/dlq-example
    description: >-
      An example to showcase the transfer of events with status 'FAILED' to a
      Dead Letter Queue.
channels:
  Event Dispatcher SQS:
    address: Event Dispatcher SQS
    description: >-
      The Validator Lambda and Worker Lambda publish messages to the Event
      Dispatcher SQS and it triggers the Event Dispatcher Lambda.
    servers:
      - $ref: '#/servers/Event Dispatcher SQS'
      - $ref: '#/servers/Validation Lambda'
      - $ref: '#/servers/Worker Lambda'
    messages:
      EventDispatcherSQSMessage:
        $ref: '#/components/messages/EventDispatcherSQSMessage'
  DLQ-Example:
    address: DQL Example
    description: >-
      An example to showcase the transfer of 'FAILED' events to a Dead Letter
      Queue.
    servers:
      - $ref: '#/servers/DLQ-Example'
      - $ref: '#/servers/Webhook-SQS'
    messages:
      PaymentEvent:
        $ref: '#/components/messages/PaymentEvent'
  HealthCheckSchedule:
    address: Health Check Lambda
    description: Periodic trigger to invoke the Health Check service.
    servers:
      - $ref: '#/servers/eventbridge-scheduler'
      - $ref: '#/servers/Health Check Lambda'
    messages:
      SchedulerEvent:
        $ref: '#/components/messages/schedulerEvent'
  POST-SQS:
    address: POST-SQS
    servers:
      - $ref: '#/servers/POST-SQS'
      - $ref: '#/servers/Request Dispatcher'
    messages:
      PaymentPostRequestSAP:
        $ref: '#/components/messages/PaymentPostRequestValidator'
  Worker-SQS:
    address: WORKER-SQS
    servers:
      - $ref: '#/servers/Worker-SQS'
      - $ref: '#/servers/Worker Lambda'
      - $ref: '#/servers/Event Dispatcher'
    messages:
      PaymentCreatedSAP:
        $ref: '#/components/messages/PaymentCreatedSAP'
  Webhook-SQS:
    address: WEBHOOK-SQS
    servers:
      - $ref: '#/servers/Webhook-SQS'
      - $ref: '#/servers/Webhook Lambda'
      - $ref: '#/servers/Event Dispatcher'
    messages:
      PaymentEvent:
        $ref: '#/components/messages/PaymentEvent'
  Logger-SQS:
    address: Logger-SQS
    servers:
      - $ref: '#/servers/Logger-SQS'
      - $ref: '#/servers/Logger Lambda'
      - $ref: '#/servers/Worker Lambda'
      - $ref: '#/servers/Validation Lambda'
      - $ref: '#/servers/Webhook Lambda'
      - $ref: '#/servers/Request Dispatcher'
    messages:
      PaymentCreatedLogger:
        $ref: '#/components/messages/PaymentPostRequestLogger'
      PaymentGetRequestLogger:
        $ref: '#/components/messages/PaymentGetRequestLogger'
      PaymentEvent:
        $ref: '#/components/messages/PaymentEvent'
operations:
  httpToRequestDispatcher:
    action: send
    channel:
      $ref: '#/channels/POST-SQS'
    summary: HTTP requests are received by RequestDispatcher and written to POST-SQS
  postSqsToValidationLambda:
    action: receive
    channel:
      $ref: '#/channels/POST-SQS'
    summary: >-
      ValidationLambda processes messages from POST-SQS, validates them, and
      writes to PaymentsCore DB
  eventDispatcherToWorkerSqs:
    action: send
    channel:
      $ref: '#/channels/Worker-SQS'
    summary: >-
      EventDispatcher reads outbox events from PaymentsCore and writes to both
      Worker-SQS.
  workerSqsToWorkerLambda:
    action: receive
    channel:
      $ref: '#/channels/Worker-SQS'
    summary: WorkerLambda processes messages from Worker-SQS and sends them to SAP
  eventDispatcherToWebhookSqs:
    action: send
    channel:
      $ref: '#/channels/Webhook-SQS'
    summary: >-
      Event Dispatcher queries the Payments Core database and sends Outbox
      Events to the Webhook SQS.
  webhookSqsToWebhookLambda:
    action: receive
    channel:
      $ref: '#/channels/Webhook-SQS'
    summary: >-
      WebhookLambda processes messages from Webhook-SQS and sends them to
      partner webhook URLs
  lambdasToLoggerSqs:
    action: send
    channel:
      $ref: '#/channels/Logger-SQS'
    summary: >-
      Request Dispatcher, Validation Lambda, Worker Lambda and Webhook Lambda
      write log messages to the Logger-SQS.
  loggerSqsToLoggerLambda:
    action: receive
    channel:
      $ref: '#/channels/Logger-SQS'
    summary: >-
      Logger-SQS sends log messages to the Logger Lambda and the Logger Lambda
      distributes the logs to the specific platforms.
  HealthCheckSchedule:
    action: receive
    channel:
      $ref: '#/channels/HealthCheckSchedule'
    summary: >-
      The EventBridge Scheduler invokes the Health Check Lambda periodically
      e.g. every x seconds.
  dlqExmapleAction:
    action: send
    channel:
      $ref: '#/channels/DLQ-Example'
    summary: >-
      Every SQS queue publishes the messages that have failed to be processed to
      its dedicated DLQ and the DLQ raises alert on the monitoring platform e.g.
      Cloud Watch.
  Event Dispatcher SQS Send:
    action: send
    channel:
      $ref: '#/channels/Event Dispatcher SQS'
    summary: >-
      The Validation Lambda and the Worker Lambda publish messages to the Event
      Dispatcher SQS.
  Event Dispatcher SQS Receive:
    action: receive
    channel:
      $ref: '#/channels/Event Dispatcher SQS'
    summary: >-
      The Event Dispatcher SQS invokes the Event Dispatcher Lambda after a
      specific batch size is reached or a specific batch window has elapsed.
components:
  schemas:
    WebhookHeaders:
      type: object
      properties:
        host:
          type: string
          example: example.com
        user-agent:
          type: string
          example: curl/7.79.1
        accept:
          type: string
          example: '*/*'
        myapp-hmac-sha1:
          type: string
          example: f237e4a4062590a674b0adc1e84614196aae79f4
        myapp-api-key:
          type: string
          format: uuid
          example: 90B649F2-70F2-4180-95BC-951F5D832F0D
        content-type:
          type: string
          enum:
            - application/json
          example: application/json
        content-length:
          type: integer
          example: 188
      required:
        - myapp-hmac-sha1
        - myapp-api-key
        - content-type
        - content-length
    WebhookPayload:
      type: object
      properties:
        webhookPayload:
          type: object
      additionalProperties: false
  messages:
    WebhookMessage:
      title: WebhookSchema
      name: WebhookSchema
      contentType: application / json
      headers:
        $ref: '#/components/schemas/WebhookHeaders'
      payload:
        $ref: '#/components/schemas/WebhookPayload'
    PaymentPostRequestLogger:
      name: PaymentPostRequestLogger
      title: Logger Payment POST Request
      summary: >-
        Logging messages for partner requests that are modified to expose
        minimal partner PII.
      payload:
        type: object
        additionalProperties: true
        properties:
          idempotencyKey:
            type: string
            format: uuid
            example: company1order2
          createdAt:
            type: string
            format: date-time
            example: 2025-12-12-15:15
        required:
          - idempotencyKey
          - createdAt
    PaymentGetRequestLogger:
      name: PaymentGetRequestLogger
      title: Logger Payment GET Request
      summary: >-
        Logging messages for partner requests that are modified to expose
        minimal partner PII.
      payload:
        type: object
        additionalProperties: true
        properties:
          idempotencyKey:
            type: string
            format: uuid
            example: company1order2
          createdAt:
            type: string
            format: date-time
            example: 2025-12-12-15:15
        required:
          - idempotencyKey
          - createdAt
    PaymentEvent:
      name: PaymentEvent
      title: Paymen Event
      summary: >-
        There are 3 kind of payment events that can be logged: PaymentCreated,
        PaymentSettled and PaymentFailed. This message is being processed by
        both the Logger queue and the Webhook Service queue.
      payload:
        properties:
          id:
            type: string
            format: uuid
            example: uuid1234
          idempKey:
            type: string
            format: uuid
            example: company12order34
            description: The unique correlation id
          eventType:
            type: string
            enum:
              - PaymentCreated
              - PaymentSettled
              - PaymentFailed
            example: PaymentCreated
          sapStatus:
            type: object
            properties:
              status:
                type: string
                enum:
                  - PENDING
                  - QUEUED
                  - SETTLED
                  - FAILED
                example: PENDING
                description: This is the status of the Payment.
              descriptioN:
                type: string
                example: Payment created.
                description: This describes the status. It can be an error / response code.
          createdAt:
            type: string
            format: date-time
            example: 2025-12-12-15:15:15
          updatedAt:
            type: string
            format: date-time
            example: 2025-12-12-15:15:15
    PaymentPostRequestValidator:
      name: PaymentPostRequestValidator
      title: Payment POST Request Validator
      summary: >-
        Initial payment POST request received via HTTP and delivered to the
        Validation Lambda
      payload:
        type: object
        properties:
          idempotencyKey:
            type: string
            format: uuid
            example: company1order2
          rawRequestBody:
            type: object
            description: The actual HTTP-Request body from the partner request.
    PaymentCreatedSAP:
      name: PaymentCreatedSAP
      title: Payment Created Event SAP
      summary: >-
        Written into Outbox when a new payment is validated and it is processed
        by Worker Lambda
      payload:
        type: object
        properties:
          id:
            type: string
            format: uuid
            example: company1order2
            description: >-
              The unique identifier that is also the idempotency key and
              correlation id for the logs.
          paymentData:
            type: object
            description: The payment data from the partner request.
          mappingRules:
            type: object
            description: Partner mapping rules for SAP
          status:
            type: string
            enum:
              - PENDING
              - QUEUED
              - SETTLED
              - FAILED
            example: QUEUED
            description: This is the current status of the payment.
          createdAt:
            type: string
            format: date-time
            example: 01-01-2001-12:12:12
          updatedAt:
            type: string
            format: date-time
            example: 01-01-2001-12:12:12
        required:
          - idempotencyKey
          - paymentData
          - mappingRules
    schedulerEvent:
      name: SchedulerEvent
      title: EventBridge Scheduled Event
      payload:
        type: object
        properties:
          version:
            type: string
            example: '0'
          id:
            type: string
            description: Unique event ID
            example: 1234-5678-90
          source:
            type: string
            example: aws.events
          detail-type:
            type: string
            example: Scheduled Event
          account:
            type: string
            example: '123456789012'
          time:
            type: string
            format: date-time
          region:
            type: string
            example: eu-central-1
          resources:
            type: array
            items:
              type: string
              example: >-
                arn:aws:events:eu-central-1:123456789012:rule/HealthCheckSchedule
          detail:
            type: object
            description: Usually empty for scheduled events
    EventDispatcherSQSMessage:
      name: EventDispatcherSQSMessage
      title: Event Dispatcher SQS Message
      payload:
        type: object
        properties:
          messageId:
            type: string
            format: uuid
            example: f12f-12gs
          details:
            type: string
            example: PaymentFailed.
